<script>
  async function calcularPrestamo() {
    const id = document.getElementById('material').value;
    const gramos = document.getElementById('gramos').value;
    const resultado = document.getElementById('resultado');

    if (!gramos || gramos <= 0) {
      resultado.innerText = 'Por favor ingresa un peso en gramos válido.';
      return;
    }

    try {
      // 1. Obtener token desde microservicio de autenticación
      const loginResponse = await fetch("http://poc-tokens-alb1-267066518.ap-south-1.elb.amazonaws.com/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          username: "admin",
          password: "admin"
        })
      });

      const loginData = await loginResponse.json();

      if (!loginResponse.ok || !loginData.token) {
        resultado.innerText = 'No se pudo obtener el token.';
        return;
      }

      const token = loginData.token;

      // 2. Usar el token para hacer la petición al microservicio de préstamos
      const response = await fetch("http://poc-empenios-alb2-510941308.ap-south-1.elb.amazonaws.com/api/v1/prestamo", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "authorization": token
        },
        body: JSON.stringify({
          idProducto: id,
          gramaje: parseFloat(gramos)
        })
      });

      const data = await response.json();
      console.log(data);

      if (response.ok && data.valorEmpenio) {
        resultado.innerHTML = `<strong>Préstamo estimado:</strong> $${data.valorEmpenio}`;
      } else if (data.message) {
        resultado.innerText = `Mensaje del servidor: ${data.message}`;
      } else {
        resultado.innerText = 'No se pudo calcular el préstamo.';
      }

    } catch (error) {
      console.error(error);
      resultado.innerText = 'Error al conectar con la API.';
    }
  }
</script>
